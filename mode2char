#!/bin/bash

set -e
set +f
shopt -s extglob
shopt -s failglob
shopt -s nullglob

# Keys   : Octal access mode.
# Values : Ascii table range 32..126 and new line 10.

declare -A mode2char=(
['200']=' ' ['204']='!' ['210']='"' ['214']='#' ['220']='$'
['224']='%' ['230']='&' ['234']="'" ['240']='(' ['244']=')'
['250']='*' ['254']='+' ['260']=',' ['264']='-' ['270']='.'
['300']='0' ['304']='1' ['310']='2' ['314']='3' ['320']='4'
['324']='5' ['330']='6' ['334']='7' ['340']='8' ['344']='9'
['350']=':' ['354']=';' ['360']='<' ['364']='=' ['370']='>'
['374']='?' ['400']='@' ['404']='A' ['410']='B' ['414']='C'
['420']='D' ['424']='E' ['430']='F' ['434']='G' ['440']='H'
['444']='I' ['450']='J' ['454']='K' ['460']='L' ['464']='M'
['470']='N' ['474']='O' ['500']='P' ['504']='Q' ['510']='R'
['514']='S' ['520']='T' ['524']='U' ['530']='V' ['534']='W'
['540']='X' ['544']='Y' ['550']='Z' ['554']='[' ['560']='\'
['564']=']' ['570']='^' ['574']='_' ['600']='`' ['604']='a'
['610']='b' ['614']='c' ['620']='d' ['624']='e' ['630']='f'
['634']='g' ['640']='h' ['644']='i' ['650']='j' ['654']='k'
['660']='l' ['664']='m' ['670']='n' ['674']='o' ['700']='p'
['704']='q' ['710']='r' ['714']='s' ['720']='t' ['724']='u'
['730']='v' ['734']='w' ['740']='x' ['744']='y' ['750']='z'
['754']='{' ['760']='|' ['764']='}' ['770']='~' ['274']='/' ['050']=$'\n' )

# Keys   : Access mode in character representation.
# Values : Ascii table range 32..126 and new line 10 in binary and decimal.
declare -A mode_human2binary=(
['----r-x---']='0001010 (10)'  ['--w-------']='0100000 (32)'  
['--w----r--']='0100001 (33)'  ['--w---x---']='0100010 (34)'  
['--w---xr--']='0100011 (35)'  ['--w--w----']='0100100 (36)'  
['--w--w-r--']='0100101 (37)'  ['--w--wx---']='0100110 (38)'  
['--w--wxr--']='0100111 (39)'  ['--w-r-----']='0101000 (40)'  
['--w-r--r--']='0101001 (41)'  ['--w-r-x---']='0101010 (42)'  
['--w-r-xr--']='0101011 (43)'  ['--w-rw----']='0101100 (44)'  
['--w-rw-r--']='0101101 (45)'  ['--w-rwx---']='0101110 (46)'  
['--w-rwxr--']='0101111 (47)'  ['--wx------']='0110000 (48)'  
['--wx---r--']='0110001 (49)'  ['--wx--x---']='0110010 (50)'  
['--wx--xr--']='0110011 (51)'  ['--wx-w----']='0110100 (52)'  
['--wx-w-r--']='0110101 (53)'  ['--wx-wx---']='0110110 (54)'
['--wx-wxr--']='0110111 (55)'  ['--wxr-----']='0111000 (56)'  
['--wxr--r--']='0111001 (57)'  ['--wxr-x---']='0111010 (58)'  
['--wxr-xr--']='0111011 (59)'  ['--wxrw----']='0111100 (60)'  
['--wxrw-r--']='0111101 (61)'  ['--wxrwx---']='0111110 (62)'  
['--wxrwxr--']='0111111 (63)'  ['-r--------']='1000000 (64)'  
['-r-----r--']='1000001 (65)'  ['-r----x---']='1000010 (66)'  
['-r----xr--']='1000011 (67)'  ['-r---w----']='1000100 (68)'  
['-r---w-r--']='1000101 (69)'  ['-r---wx---']='1000110 (70)'  
['-r---wxr--']='1000111 (71)'  ['-r--r-----']='1001000 (72)'  
['-r--r--r--']='1001001 (73)'  ['-r--r-x---']='1001010 (74)'  
['-r--r-xr--']='1001011 (75)'  ['-r--rw----']='1001100 (76)'  
['-r--rw-r--']='1001101 (77)'  ['-r--rwx---']='1001110 (78)'  
['-r--rwxr--']='1001111 (79)'  ['-r-x------']='1010000 (80)'  
['-r-x---r--']='1010001 (81)'  ['-r-x--x---']='1010010 (82)'  
['-r-x--xr--']='1010011 (83)'  ['-r-x-w----']='1010100 (84)'  
['-r-x-w-r--']='1010101 (85)'  ['-r-x-wx---']='1010110 (86)'  
['-r-x-wxr--']='1010111 (87)'  ['-r-xr-----']='1011000 (88)'  
['-r-xr--r--']='1011001 (89)'  ['-r-xr-x---']='1011010 (90)'  
['-r-xr-xr--']='1011011 (91)'  ['-r-xrw----']='1011100 (92)'  
['-r-xrw-r--']='1011101 (93)'  ['-r-xrwx---']='1011110 (94)'  
['-r-xrwxr--']='1011111 (95)'  ['-rw-------']='1100000 (96)'  
['-rw----r--']='1100001 (97)'  ['-rw---x---']='1100010 (98)'  
['-rw---xr--']='1100011 (99)'  ['-rw--w----']='1100100 (100)' 
['-rw--w-r--']='1100101 (101)' ['-rw--wx---']='1100110 (102)' 
['-rw--wxr--']='1100111 (103)' ['-rw-r-----']='1101000 (104)' 
['-rw-r--r--']='1101001 (105)' ['-rw-r-x---']='1101010 (106)' 
['-rw-r-xr--']='1101011 (107)' ['-rw-rw----']='1101100 (108)' 
['-rw-rw-r--']='1101101 (109)' ['-rw-rwx---']='1101110 (110)' 
['-rw-rwxr--']='1101111 (111)' ['-rwx------']='1110000 (112)' 
['-rwx---r--']='1110001 (113)' ['-rwx--x---']='1110010 (114)' 
['-rwx--xr--']='1110011 (115)' ['-rwx-w----']='1110100 (116)' 
['-rwx-w-r--']='1110101 (117)' ['-rwx-wx---']='1110110 (118)' 
['-rwx-wxr--']='1110111 (119)' ['-rwxr-----']='1111000 (120)' 
['-rwxr--r--']='1111001 (121)' ['-rwxr-x---']='1111010 (122)' 
['-rwxr-xr--']='1111011 (123)' ['-rwxrw----']='1111100 (124)' 
['-rwxrw-r--']='1111101 (125)' ['-rwxrwx---']='1111110 (126)' )

Oops...() {
echo 'Oops...'
echo "Line:$1"
exit
}

workdir="$1"
cd -P "$workdir"

while read -ra file_mode
do
    (( ${#file_mode[@]} == 3 )) || Oops... "$LINENO"
    
    file="${file_mode[0]}"
    mode_octal="${file_mode[1]}"
    mode_human="${file_mode[2]}"
    mode_human_binary="${mode_human2binary["$mode_human"]}"
    
    [[ "$mode_human_binary" ]] || Oops... "$LINENO"
    
    char="${mode2char["$mode_octal"]}"
    [[ "$char" ]] || Oops... "$LINENO"

        echo
    printf '%-15s(%s)\n'  "$mode_human"      "$mode_octal"
    printf '%-15s(%s)\n' " $mode_human_binary" "${char@Q}"

    result+="$char"                       # Accumulate in memory :(

# Filename substitution mechanism is used ./+([0-9]). See man bash.   
# If the directory contains millions of files. Whose names are made 
# up of digits. Your memory will say goodbye.
done < <(stat -c'%n %03a %A' ./+([0-9]))

[[ "$result" ]] || exit
echo -e '\nTop Secret :)'
echo "$result" 
